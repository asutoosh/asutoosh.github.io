<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Trading ‚Äî PnL</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 x=%22.1em%22 font-size=%2290%22>üìà</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b0c10; --panel:#111218; --text:#e6eaf0; --muted:#a9b1c3;
      --brand:#66e3ff; --brand-2:#ae7bff; --ring: color-mix(in oklch, var(--brand), white 20%);
      --border: color-mix(in oklch, var(--text), black 85%); --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px; --gap:clamp(16px, 2.2vw, 28px); --maxw:1100px; --h1:clamp(40px,6vw,64px);
      --pos:#22c55e; /* profit green */ --neg:#ef4444; /* loss red */
    }
    :root.light{
      --bg:#f6f7fb; --panel:#ffffff; --text:#0f172a; --muted:#475569;
      --brand:#2563eb; --brand-2:#9333ea; --border: color-mix(in oklch, var(--text), white 80%);
      --shadow: 0 10px 30px rgba(0,0,0,.1);
    }
    *,*::before,*::after{box-sizing:border-box} *{margin:0}
    body{
      min-height:100vh; background:
        radial-gradient(1200px 600px at 90% -10%, color-mix(in oklch, var(--brand) 30%, transparent), transparent 70%),
        radial-gradient(900px 500px at -10% 20%, color-mix(in oklch, var(--brand-2) 24%, transparent), transparent 60%),
        var(--bg);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    .container{width:min(100% - 2*var(--gap), var(--maxw)); margin-inline:auto}
    header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(10px);
      background: color-mix(in oklch, var(--bg) 85%, transparent); border-bottom:1px solid var(--border)}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; padding-block:14px}
    .btn{border:1px solid var(--border); background:var(--panel); color:var(--text);
      padding:.56rem .9rem; border-radius:12px; text-decoration:none; display:inline-flex; align-items:center; gap:8px; box-shadow:var(--shadow)}
    .panel{background:linear-gradient(180deg, color-mix(in oklch, var(--panel), transparent 15%), var(--panel));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    h1{font-size:var(--h1); line-height:1.05; letter-spacing:-.02em}
    .muted{color:var(--muted)}
    main{padding-block: clamp(32px, 6vw, 64px)}
    .grid{display:grid; gap:clamp(14px,2vw,22px)}
    .grid-2{grid-template-columns:2fr 1fr} @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }
    .card{padding:18px}
    .stat{font-size:28px; font-weight:800}
    .controls{display:flex; align-items:center; gap:12px; margin-top:10px}
    .select{border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:10px; padding:.5rem .7rem}
    :focus-visible{outline:2px solid var(--ring); outline-offset:2px; border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="btn" href="index.html">‚Üê Back</a>
      <div style="display:flex; align-items:center; gap:10px">
        <button class="btn" id="themeToggle" role="switch" aria-checked="false" title="Toggle theme">üåì <span class="label">Dark</span></button>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>Daily PnL & Total Value</h1>
    <p class="muted">Auto-updated from Google Sheets at 5:30 AM IST</p>

    <div class="controls">
      <label for="rangeSelect" class="muted">Range:</label>
      <select id="rangeSelect" class="select" aria-label="Time range">
        <option value="7" selected>Last 7 days</option>
        <option value="30">Last 1 month</option>
      </select>
      <a class="btn" id="openRaw" href="#" target="_blank" rel="noopener">Open Raw JSON</a>
    </div>

    <div class="grid grid-2" style="margin-top:16px">
      <div class="grid" style="align-content:start">
        <div class="panel card">
          <h2 style="margin-bottom:8px">Asset Value (Total)</h2>
          <canvas id="chartTotal" height="140" aria-label="Total Value chart" role="img"></canvas>
        </div>
        <div class="panel card">
          <h2 style="margin-bottom:8px">Daily PnL</h2>
          <canvas id="chartPnl" height="140" aria-label="Daily PnL chart" role="img"></canvas>
        </div>
        <div class="panel card">
          <h2 style="margin-bottom:8px">Lifetime PnL</h2>
          <canvas id="chartLife" height="140" aria-label="Lifetime PnL chart" role="img"></canvas>
        </div>
      </div>

      <div class="panel card">
        <div class="stat" id="latestTotal">‚Äî</div>
        <div class="muted">Latest Total Value</div>
        <div style="height:12px"></div>
        <div class="stat" id="latestPnl">‚Äî</div>
        <div class="muted">Latest Daily PnL</div>
        <div style="height:12px"></div>
        <div class="muted" id="updatedAt">Updated: ‚Äî</div>
      </div>
    </div>
  </main>

  <script>
    // ====== SET YOUR /exec URL ======
    const API_URL = 'https://script.google.com/macros/s/AKfycbxvLrTsuDrN-hLpRC064ono14txRwsqpotV96FD0X0n0ZdhJhlk3UvZFV0racA0MAd5/exec';

    // ====== THEME TOGGLE ======
    let chartTotal = null, chartPnl = null, chartLife = null;
    (function(){
      const root = document.documentElement;
      const toggle = document.getElementById('themeToggle');
      const saved = localStorage.getItem('theme');
      const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
      function setTheme(mode){
        if(mode === 'light'){ root.classList.add('light'); toggle.setAttribute('aria-checked','false'); toggle.querySelector('.label').textContent='Light'; }
        else { root.classList.remove('light'); toggle.setAttribute('aria-checked','true'); toggle.querySelector('.label').textContent='Dark'; }
        localStorage.setItem('theme', mode);
        if (chartPnl) chartPnl.update();
        if (chartTotal) chartTotal.update();
        if (chartLife) chartLife.update();
      }
      setTheme(saved ?? (prefersLight ? 'light' : 'dark'));
      toggle.addEventListener('click', ()=> setTheme(root.classList.contains('light') ? 'dark' : 'light'));
    })();

    // ====== USD formatter ======
    const LOCALE = 'en-US';
    const CURRENCY = 'USD';
    function fmt(n){ return new Intl.NumberFormat(LOCALE, { style:'currency', currency:CURRENCY, maximumFractionDigits: 2 }).format(n); }

    // ====== date helpers ======
    function parseDM(str){
      if(!str) return new Date(0);
      const [dRaw, monRaw] = String(str).trim().split(/\s+/);
      const d = parseInt(dRaw, 10);
      const key = (monRaw || '').toLowerCase().replace('.', '');
      const map = {
        jan:0, january:0, feb:1, february:1, mar:2, march:2, apr:3, april:3,
        may:4, jun:5, june:5, jul:6, july:6, aug:7, august:7,
        sep:8, sept:8, september:8, oct:9, october:9, nov:10, november:10, dec:11, december:11
      };
      const m = map[key];
      const y = new Date().getFullYear();
      return (m == null || isNaN(d)) ? new Date(0) : new Date(y, m, d);
    }
    function filterByDays(items, days){
      const today = new Date(); today.setHours(0,0,0,0);
      const cutoff = new Date(today); cutoff.setDate(today.getDate() - (days - 1));
      return items.filter(it => it._d >= cutoff && it._d <= today);
    }

    // ====== data fetch & prep (robust) ======
    async function fetchItems(){
      const url = API_URL + '?ts=' + Date.now();
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);

      const json = await res.json();
      const today = new Date(); today.setHours(0,0,0,0);

      let items = (json.items || [])
        .map(it => ({ ...it, _d: parseDM(it.date) }))
        .filter(it => it._d <= today)
        .sort((a,b) => a._d - b._d);

      // Safe lifetime fallback if backend didn't send it
      if (items.length > 0 && !('lifetime' in items[0])) {
        let acc = 0;
        items = items.map(it => ({ ...it, lifetime: (acc += (Number(it.pnl)||0)) }));
      }
      return items;
    }

    // ====== helpers ======
    function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function safeY(ctx){ // for scriptable options/tooltip where parsed may be missing
      if (ctx && ctx.parsed && typeof ctx.parsed.y === 'number') return ctx.parsed.y;
      if (ctx && typeof ctx.raw === 'number') return ctx.raw;
      return 0;
    }

    // ====== charts ======
    function ensureCharts(){
      if(!chartTotal){
        chartTotal = new Chart(document.getElementById('chartTotal'), {
          type: 'line',
          data: { labels: [], datasets: [{ label: 'Total Value', data: [], tension: 0.25, spanGaps: true }] },
          options: {
            responsive: true, interaction: { mode: 'index', intersect: false },
            scales: { y: { ticks: { callback: v => fmt(v) } }, x: { ticks: { maxRotation: 0 } } },
            plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: c => c.dataset.label + ': ' + fmt(safeY(c)) } } }
          }
        });
      }
      if(!chartPnl){
        chartPnl = new Chart(document.getElementById('chartPnl'), {
          type: 'bar',
          data: { labels: [], datasets: [{
            label: 'Daily PnL',
            data: [],
            backgroundColor: (ctx) => {
              const v = safeY(ctx);
              if (v > 0) return cssVar('--pos') || '#22c55e';
              if (v < 0) return cssVar('--neg') || '#ef4444';
              return cssVar('--muted') || '#a9b1c3';
            },
            borderColor: (ctx) => {
              const v = safeY(ctx);
              if (v > 0) return cssVar('--pos') || '#22c55e';
              if (v < 0) return cssVar('--neg') || '#ef4444';
              return cssVar('--muted') || '#a9b1c3';
            },
            borderWidth: 1
          }]},
          options: {
            responsive: true, interaction: { mode: 'index', intersect: false },
            scales: { y: { ticks: { callback: v => fmt(v) } }, x: { ticks: { maxRotation: 0 } } },
            plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: c => c.dataset.label + ': ' + fmt(safeY(c)) } } }
          }
        });
      }
      if(!chartLife){
        chartLife = new Chart(document.getElementById('chartLife'), {
          type: 'line',
          data: { labels: [], datasets: [{ label: 'Lifetime PnL', data: [], tension: 0.25, spanGaps: true }] },
          options: {
            responsive: true, interaction: { mode: 'index', intersect: false },
            scales: { y: { ticks: { callback: v => fmt(v) } }, x: { ticks: { maxRotation: 0 } } },
            plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: c => c.dataset.label + ': ' + fmt(safeY(c)) } } }
          }
        });
      }
    }

    function updateCharts(items){
      if(!items || !items.length){
        alert('No data to display yet.');
        return;
      }
      ensureCharts();

      const labels   = items.map(i => i.date);
      const totals   = items.map(i => Number(i.total) || 0);
      const pnls     = items.map(i => Number(i.pnl) || 0);
      const lifetime = items.map(i => Number(i.lifetime) || 0);

      chartTotal.data.labels = labels;
      chartTotal.data.datasets[0].data = totals;
      chartTotal.update();

      chartPnl.data.labels = labels;
      chartPnl.data.datasets[0].data = pnls;
      chartPnl.update();

      chartLife.data.labels = labels;
      chartLife.data.datasets[0].data = lifetime;
      chartLife.update();

      const last = items[items.length - 1];
      document.getElementById('latestTotal').textContent = fmt(Number(last.total)||0);
      document.getElementById('latestPnl').textContent   = ((Number(last.pnl)||0) >= 0 ? '+' : '') + fmt(Number(last.pnl)||0);
      document.getElementById('updatedAt').textContent   = 'Updated: ' + new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
    }

    // ====== init & range handling ======
    (async function init(){
      try{
        const allItems = await fetchItems();
        document.getElementById('openRaw').href = API_URL + '?ts=' + Date.now();

        const select = document.getElementById('rangeSelect');
        function applyRange(){
          const days = Number(select.value) || 7;           // 7 or 30
          let items = filterByDays(allItems, days);
          if (!items.length) items = allItems.slice(-days);
          updateCharts(items);
        }
        select.addEventListener('change', applyRange);
        applyRange(); // default (7 days)
      }catch(e){
        alert('Could not load data: ' + (e && e.message ? e.message : e));
        console.error(e);
      }
    })();
  </script>
</body>
</html>
